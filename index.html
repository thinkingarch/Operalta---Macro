<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operalta - Macro (Bayesian)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Playfair Display', serif;
            background-color: #030712; /* bg-gray-950 */
            color: #d1d5db; /* text-gray-300 */
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .loader {
            border: 4px solid #4b5563; /* border-gray-600 */
            border-top: 4px solid #3b82f6; /* border-blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sidebar-icon {
            width: 24px;
            height: 24px;
        }
        .view-content {
            display: none;
        }
        .view-content.active {
            display: block;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .cpt-table { border-collapse: collapse; width: 100%; font-size: 0.8rem; }
        .cpt-table th, .cpt-table td { border: 1px solid #374151; padding: 6px 8px; text-align: left;}
        .cpt-table th { background-color: #1f2937; }
        .cpt-table input {
            background-color: transparent;
            color: #d1d5db;
            width: 50px;
            text-align: right;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .cpt-table input:focus {
            outline: none;
            border: 1px solid #3b82f6;
            background-color: #111827;
        }
        .prob-bar-container { background-color: #374151; border-radius: 4px; overflow: hidden; display: flex; height: 1.25rem; }
        .prob-bar { display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }
        .trend-button {
            background-color: #374151; /* bg-gray-700 */
            transition: background-color 0.2s;
        }
        .trend-button.active {
            background-color: #2563eb; /* bg-blue-600 */
        }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <nav class="w-72 bg-gray-900 p-6 space-y-4 border-r border-gray-800 flex-shrink-0 h-screen sticky top-0 overflow-y-auto">
        <div class="flex items-center space-x-3 mb-8">
            <svg class="h-8 w-8" viewBox="0 0 40 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 2.5C31.0457 2.5 39 10.2825 39 10.2825C39 10.2825 31.0457 18.065 20 18.065C8.9543 18.065 1 10.2825 1 10.2825C1 10.2825 8.9543 2.5 20 2.5Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 9.5C31.0457 9.5 39 17.2825 39 17.2825C39 17.2825 31.0457 25.065 20 25.065C8.9543 25.065 1 17.2825 1 17.2825C1 17.2825 8.9543 9.5 20 9.5Z" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 16.5C31.0457 16.5 39 24.2825 39 24.2825C39 17.2825 31.0457 32.065 20 32.065C8.9543 32.065 1 24.2825 1 24.2825C1 17.2825 8.9543 16.5 20 16.5Z" stroke="#db2777" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-2xl font-bold text-white">Operalta - Macro</h1>
        </div>
        <a href="#" class="nav-link flex items-center space-x-3 p-3 rounded-lg bg-gray-800 text-white" data-view="dashboard">
            <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" /></svg>
            <span class="font-medium">Dashboard</span>
        </a>
        <a href="#" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800/50 text-gray-400" data-view="model">
             <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg>
            <span class="font-medium">Bayesian Model</span>
        </a>
        <a href="#" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800/50 text-gray-400" data-view="sources">
            <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg>
            <span class="font-medium">Data Sources</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 overflow-y-auto h-screen">
        
        <!-- View: Dashboard -->
        <div id="view-dashboard" class="view-content active">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                <p class="text-gray-400">Welcome to Operalta. Here's a quick overview of macro insights.</p>
            </div>

            <!-- ACTION CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Stat Card -->
                <div class="bg-gray-900 p-6 rounded-lg border border-gray-800 flex flex-col">
                    <h4 class="text-gray-400 text-sm font-medium">Data Sources Active</h4>
                    <p id="data-sources-active" class="text-3xl font-semibold text-white mt-2">0</p>
                </div>

                <!-- Data Discovery Card -->
                <div class="bg-blue-600/90 p-6 rounded-lg text-white flex flex-col">
                    <h4 class="font-bold">Data Discovery</h4>
                    <p class="text-sm text-blue-100 mt-1 mb-3">Select Country →</p>
                    <input type="text" id="country-input" list="country-list" class="w-full mt-auto p-2 border-none rounded-md bg-blue-900/70 text-white" placeholder="Type a country name...">
                    <datalist id="country-list"></datalist>
                </div>

                <!-- Synthesize Data Card -->
                <div class="bg-orange-500/90 p-6 rounded-lg text-white flex flex-col">
                    <h4 class="font-bold">Synthesize Data</h4>
                    <p class="text-sm text-orange-100 mt-1 mb-3">Run the analysis for the selected country →</p>
                    <button id="analyze-btn" class="w-full mt-auto bg-white/20 text-white font-semibold py-2 px-4 rounded-md hover:bg-white/30 transition">Run Analysis</button>
                </div>

                <!-- Dynamic Modeling Card -->
                <div class="bg-pink-600/90 p-6 rounded-lg text-white flex flex-col">
                    <h4 class="font-bold">Dynamic Modeling</h4>
                    <p class="text-sm text-pink-100 mt-1 mb-3">Explore Bayesian Models →</p>
                    <button id="explore-model-btn" class="w-full mt-auto bg-white/20 text-white font-semibold py-2 px-4 rounded-md hover:bg-white/30 transition">Explore Models</button>
                </div>
            </div>
            
            <div id="loader" class="loader hidden mx-auto my-16"></div>
            
            <div id="dashboard-content-wrapper" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gray-900 p-6 rounded-lg border border-gray-800">
                        <h3 class="text-xl font-semibold text-white mb-4">Cycle Analysis and Trends</h3>
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold mb-2 text-white">Hegemonic Cycle Position</h4>
                            <div id="hegemonic-distribution" class="mt-2"></div>
                        </div>
                        <div id="cycle-explanation-scenarios" class="mt-6 text-sm text-gray-400 space-y-4"></div>
                        <div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center my-4 pt-6 border-t border-gray-800">
                                <h4 class="text-lg font-semibold text-white mb-3 md:mb-0">Historical Trends</h4>
                                <div id="trend-indicator-buttons" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="chart-container"><canvas id="historical-chart"></canvas></div>
                        </div>
                    </div>
                    <div class="bg-gray-900 p-6 rounded-lg border border-gray-800">
                         <h3 class="text-xl font-semibold text-white mb-4">Core Diagnostics</h3>
                         <div id="core-diagnostics-container" class="space-y-6">
                             <!-- Diagnostics will be inserted here -->
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Model Explorer -->
        <div id="view-model" class="view-content">
            <div class="bg-gray-900 border border-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-2 text-white">Bayesian Network Structure</h2>
                <p class="text-gray-400 mb-6">This model represents macroeconomic factors as a network of probabilities. Each node's state (e.g., 'Strong', 'Weak') is determined by the probabilistic states of its parent nodes, based on Conditional Probability Tables (CPTs).</p>
                
                <div id="model-graph-container" class="bg-gray-900/50 p-4 rounded-lg mb-8 overflow-x-auto"></div>
                
                <h3 class="text-xl font-semibold text-white mb-4">Conditional Probability Tables (CPTs)</h3>
                <p class="text-gray-400 mb-6 text-sm">You can directly edit the probabilities below. Values in a row are automatically normalized to sum to 100%. The analysis will re-run on every change.</p>
                <div id="model-cpt-content" class="space-y-8"></div>
            </div>
        </div>

        <!-- View: Data Sources -->
        <div id="view-sources" class="view-content">
            <div class="bg-gray-900 border border-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 text-white">Data Source Management</h2>
                <div id="data-sources-content" class="space-y-4"></div>
            </div>
        </div>

    </main>

    <script type="module">
    // --- App State & Config ---
    let historicalChart;
    const COUNTRIES = { 'USA': 'United States', 'CHN': 'China', 'DEU': 'Germany', 'JPN': 'Japan', 'IND': 'India', 'RUS': 'Russia', 'BRA': 'Brazil', 'GBR': 'United Kingdom', 'FRA': 'France', 'ITA': 'Italy', 'CAN': 'Canada', 'AUS': 'Australia', 'KOR': 'South Korea', 'MEX': 'Mexico', 'IDN': 'Indonesia', 'SAU': 'Saudi Arabia', 'TUR': 'Turkey', 'ARG': 'Argentina', 'ZAF': 'South Africa', 'NGA': 'Nigeria' };
    const TREND_INDICATORS = { 'GDP Growth (%)': { source: 'WB', code: 'NY.GDP.MKTP.KD.ZG' }, 'Military Spending (% GDP)': { source: 'WB', code: 'MS.MIL.XPND.GD.ZS' }, 'Unemployment (%)': { source: 'WB', code: 'SL.UEM.TOTL.NE.ZS' }, 'Government Debt (% GDP)': { source: 'IMF', code: 'GGXWDG_NGDP' }, 'Political Stability': {source: 'WB', code: 'PV.PER.RNK'}};
    const STATIC_DATA = {
        EPI: { 'USA': 51.1, 'CHN': 28.4, 'DEU': 77.2, 'JPN': 75.1, 'IND': 18.9, 'RUS': 37.5, 'BRA': 43.6, 'GBR': 81.3, 'FRA': 80.0, 'ITA': 78.8, 'CAN': 71.8, 'AUS': 74.9, 'KOR': 62.1, 'MEX': 45.5, 'IDN': 28.2, 'SAU': 37.9, 'TUR': 46.8, 'ARG': 41.1, 'ZAF': 36.6, 'NGA': 28.3 },
        ND_GAIN: { 'USA': 69.8, 'CHN': 60.3, 'DEU': 72.5, 'JPN': 71.2, 'IND': 48.9, 'RUS': 62.5, 'BRA': 56.9, 'GBR': 73.1, 'FRA': 73.8, 'ITA': 68.4, 'CAN': 71.6, 'AUS': 74.5, 'KOR': 69.1, 'MEX': 58.1, 'IDN': 51.3, 'SAU': 59.8, 'TUR': 59.5, 'ARG': 57.7, 'ZAF': 53.9, 'NGA': 35.6 }
    };
    let dataSources = {
        worldBank: { name: 'World Bank', enabled: true, apiKey: '', type: 'public' },
        imf: { name: 'International Monetary Fund', enabled: true, apiKey: '', type: 'public' },
        oecd: { name: 'OECD', enabled: true, apiKey: '', type: 'public' },
        epi: { name: 'Yale EPI (2022)', enabled: true, apiKey: '', type: 'static' },
        ndGain: { name: 'ND-GAIN (2021)', enabled: true, apiKey: '', type: 'static' },
    };
    const OECD_COUNTRIES = ['AUS', 'CAN', 'DEU', 'FRA', 'GBR', 'ITA', 'JPN', 'KOR', 'MEX', 'TUR', 'USA'];
    let countryInput, analyzeBtn, loader, dashboardContentWrapper, exploreModelBtn;
    let currentCountryCode = 'USA';
    let currentTrendIndicator = 'GDP Growth (%)';

    // --- Bayesian Network Definition ---
    const STATES = { Weak: 0, Moderate: 1, Strong: 2 };
    const REVERSE_STATES = ['Weak', 'Moderate', 'Strong'];
    const CYCLE_STATES = { Rise: 0, Consolidation: 1, Decline: 2, Transition: 3 };
    const REVERSE_CYCLE_STATES = ['Rise', 'Consolidation', 'Decline', 'Transition'];

    const LEAF_NODES = {
        // Biosphere Integrity parents
        epi: 'EPI', nd_gain: 'ND-GAIN', co2: 'CO2', renewable: 'Renewable',
        // Demographic Dynamism parents
        fertility: 'Fertility', age_dependency: 'Age Depend.',
        // Economic Engine parents
        gdp_pc: 'GDP/Cap', current_account: 'Current Acc.', manuf_vs_finance: 'Manuf/Fin Ratio',
        // Tech Capacity parents
        rd_exp: 'R&D Exp.', patents: 'Patents', internet_users: 'Internet Users',
        // Social Cohesion parents
        gini: 'Inequality', corruption_control: 'Corruption Ctrl', rule_of_law: 'Rule of Law', political_stability: 'P. Stability',
        // Relative Power Projection parent
        military_exp: 'Military Exp.',
    };

    // 1. Discretization thresholds for raw indicators
    const DISCRETIZATION_THRESHOLDS = {
        epi: [40, 60], nd_gain: [50, 65], co2: [15, 5, true], renewable: [20, 60],
        fertility: [1.5, 2.5], age_dependency: [60, 50, true],
        gdp_pc: [20000, 55000], current_account: [-2, 2], manuf_vs_finance: [0.8, 1.5],
        rd_exp: [1, 2.5], patents: [10000, 100000], internet_users: [60, 90],
        gini: [0.45, 0.35, true], corruption_control: [25, 75], rule_of_law: [25, 75], political_stability: [25, 75],
        military_exp: [1, 3],
    };

    // 2. Network Structure (Parents for each node)
    const NETWORK_STRUCTURE = {
        // Layer 1
        biosphereIntegrity: ['epi', 'nd_gain', 'co2', 'renewable'],
        demographicDynamism: ['fertility', 'age_dependency', 'biosphereIntegrity'],
        // Layer 2
        economicEngineType: ['gdp_pc', 'current_account', 'manuf_vs_finance', 'demographicDynamism'],
        technologicalCapacity: ['rd_exp', 'patents', 'internet_users', 'economicEngineType'],
        socialCohesion: ['gini', 'corruption_control', 'rule_of_law', 'political_stability', 'economicEngineType'],
        // Layer 3
        nationalResilience: ['socialCohesion', 'biosphereIntegrity', 'demographicDynamism', 'economicEngineType'],
        relativePowerProjection: ['economicEngineType', 'technologicalCapacity', 'military_exp'],
        hegemonicCyclePosition: ['nationalResilience', 'relativePowerProjection']
    };

    // 3. Conditional Probability Tables (CPTs)
    let CPTs = {
        biosphereIntegrity: {
            weights: { epi: 0.3, nd_gain: 0.3, co2: 0.2, renewable: 0.2 },
            table: [ { Weak: 0.6, Moderate: 0.3, Strong: 0.1 }, { Weak: 0.2, Moderate: 0.6, Strong: 0.2 }, { Weak: 0.1, Moderate: 0.3, Strong: 0.6 } ]
        },
        demographicDynamism: {
            weights: { fertility: 0.4, age_dependency: 0.4, biosphereIntegrity: 0.2 },
            table: [ { Weak: 0.6, Moderate: 0.3, Strong: 0.1 }, { Weak: 0.2, Moderate: 0.6, Strong: 0.2 }, { Weak: 0.1, Moderate: 0.3, Strong: 0.6 } ]
        },
        economicEngineType: {
            weights: { gdp_pc: 0.3, current_account: 0.25, manuf_vs_finance: 0.2, demographicDynamism: 0.25 },
            table: [ { Weak: 0.8, Moderate: 0.15, Strong: 0.05 }, { Weak: 0.2, Moderate: 0.6, Strong: 0.2 }, { Weak: 0.05, Moderate: 0.25, Strong: 0.7 } ]
        },
        technologicalCapacity: {
            weights: { economicEngineType: 0.2, rd_exp: 0.4, patents: 0.25, internet_users: 0.15 },
            table: [ { Weak: 0.7, Moderate: 0.25, Strong: 0.05 }, { Weak: 0.1, Moderate: 0.6, Strong: 0.3 }, { Weak: 0.0, Moderate: 0.2, Strong: 0.8 } ]
        },
        socialCohesion: {
            weights: { economicEngineType: 0.2, gini: 0.3, corruption_control: 0.2, rule_of_law: 0.15, political_stability: 0.15 },
            table: [ { Weak: 0.7, Moderate: 0.25, Strong: 0.05 }, { Weak: 0.15, Moderate: 0.7, Strong: 0.15 }, { Weak: 0.05, Moderate: 0.2, Strong: 0.75 } ]
        },
        nationalResilience: {
            weights: { socialCohesion: 0.4, economicEngineType: 0.3, biosphereIntegrity: 0.15, demographicDynamism: 0.15 },
            table: [ { Weak: 0.7, Moderate: 0.25, Strong: 0.05 }, { Weak: 0.15, Moderate: 0.7, Strong: 0.15 }, { Weak: 0.05, Moderate: 0.2, Strong: 0.75 } ]
        },
        relativePowerProjection: {
            weights: { economicEngineType: 0.5, technologicalCapacity: 0.4, military_exp: 0.1 },
            table: [ { Weak: 0.8, Moderate: 0.15, Strong: 0.05 }, { Weak: 0.2, Moderate: 0.6, Strong: 0.2 }, { Weak: 0.05, Moderate: 0.25, Strong: 0.7 } ]
        },
        hegemonicCyclePosition: {
            table: {
                // Resilience: Weak
                Weak: {
                    Weak:       { Rise: 0.05, Consolidation: 0.0,  Decline: 0.70, Transition: 0.25 },
                    Moderate:   { Rise: 0.10, Consolidation: 0.0,  Decline: 0.60, Transition: 0.30 },
                    Strong:     { Rise: 0.15, Consolidation: 0.05, Decline: 0.45, Transition: 0.35 }
                },
                // Resilience: Moderate
                Moderate: {
                    Weak:       { Rise: 0.15, Consolidation: 0.05, Decline: 0.50, Transition: 0.30 },
                    Moderate:   { Rise: 0.40, Consolidation: 0.2,  Decline: 0.20, Transition: 0.20 },
                    Strong:     { Rise: 0.50, Consolidation: 0.4,  Decline: 0.05, Transition: 0.05 }
                },
                // Resilience: Strong
                Strong: {
                    Weak:       { Rise: 0.30, Consolidation: 0.10, Decline: 0.20, Transition: 0.40 },
                    Moderate:   { Rise: 0.40, Consolidation: 0.50, Decline: 0.05, Transition: 0.05 },
                    Strong:     { Rise: 0.10, Consolidation: 0.85, Decline: 0.0,  Transition: 0.05 }
                }
            }
        }
    };

    function initialize() {
        countryInput = document.getElementById('country-input');
        analyzeBtn = document.getElementById('analyze-btn');
        exploreModelBtn = document.getElementById('explore-model-btn');
        loader = document.getElementById('loader');
        dashboardContentWrapper = document.getElementById('dashboard-content-wrapper');
        
        populateCountryDatalist();
        countryInput.value = COUNTRIES[currentCountryCode];

        createTrendIndicatorButtons();

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.dataset.view);
            });
        });

        analyzeBtn.addEventListener('click', runAnalysis);
        exploreModelBtn.addEventListener('click', () => switchView('model'));
        countryInput.addEventListener('change', handleCountryInputChange);
        
        buildModelExplorer();
        buildDataSourcesManager();
        runAnalysis();
    }

    function populateCountryDatalist() {
        const datalist = document.getElementById('country-list');
        for (const code in COUNTRIES) {
            const option = document.createElement('option');
            option.value = COUNTRIES[code];
            datalist.appendChild(option);
        }
    }

    function createTrendIndicatorButtons() {
        const container = document.getElementById('trend-indicator-buttons');
        container.innerHTML = '';
        for (const key in TREND_INDICATORS) {
            const button = document.createElement('button');
            button.className = `trend-button text-xs font-semibold py-1 px-3 rounded-md`;
            if (key === currentTrendIndicator) {
                button.classList.add('active');
            }
            button.textContent = key;
            button.dataset.indicatorKey = key;
            button.addEventListener('click', handleTrendButtonClick);
            container.appendChild(button);
        }
    }

    function handleCountryInputChange() {
        const inputValue = countryInput.value;
        const countryCode = Object.keys(COUNTRIES).find(code => COUNTRIES[code] === inputValue);
        if (countryCode) {
            currentCountryCode = countryCode;
            runAnalysis();
        } else {
            // Optional: handle invalid country name
            console.warn("Invalid country name entered");
        }
    }

    function handleTrendButtonClick(e) {
        currentTrendIndicator = e.target.dataset.indicatorKey;
        // Update active state on buttons
        document.querySelectorAll('.trend-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.indicatorKey === currentTrendIndicator);
        });
        runAnalysis();
    }

    function switchView(viewId) {
        document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.remove('bg-gray-800', 'text-white');
            l.classList.add('hover:bg-gray-800/50', 'text-gray-400');
        });
        document.querySelector(`.nav-link[data-view="${viewId}"]`).classList.add('bg-gray-800', 'text-white');
    }

    // --- Data Fetching ---
    async function fetchData(countryCode) {
        const wbIndicators = 'NY.GDP.PCAP.CD;NV.IND.MANF.ZS;MS.MIL.XPND.GD.ZS;IP.PAT.RESD;PV.PER.RNK;RL.PER.RNK;CC.PER.RNK;SP.DYN.TFRT.IN;SP.POP.DPND.OL;SP.POP.DPND.YG;EN.ATM.CO2E.PC;EG.ELC.RNWX.ZS;BN.CAB.XOKA.GD.ZS;NV.FSM.TOTL.ZS;IT.NET.USER.ZS;GB.XPD.RSDV.GD.ZS';
        const promises = [
            dataSources.worldBank.enabled ? fetchWorldBankData(countryCode, wbIndicators) : Promise.resolve({}),
            dataSources.imf.enabled ? fetchImfData(countryCode, 'GGXWDG_NGDP') : Promise.resolve({}),
            dataSources.oecd.enabled && OECD_COUNTRIES.includes(countryCode) ? fetchOecdGini(countryCode) : Promise.resolve(null)
        ];
        
        const [wbData, imfData, oecdGini] = await Promise.all(promises);
        const combinedData = { ...wbData, ...imfData };
        if (oecdGini && (!combinedData.SI_POV_GINI || (combinedData.SI_POV_GINI.date && oecdGini.date > combinedData.SI_POV_GINI.date))) {
            combinedData.SI_POV_GINI = oecdGini;
        }
        combinedData.EPI = { value: STATIC_DATA.EPI[countryCode] || null };
        combinedData.ND_GAIN = { value: STATIC_DATA.ND_GAIN[countryCode] || null };
        return combinedData;
    }

    async function fetchWorldBankData(countryCode, indicators, dateRange = '2015:2023', forChart = false) {
        const url = `https://api.worldbank.org/v2/country/${countryCode}/indicator/${indicators}?date=${dateRange}&format=json&per_page=1000`;
        try {
            const res = await fetch(url);
            if (!res.ok) { console.error(`WB API Error: ${res.status}`); return forChart ? [] : {}; }
            const raw = await res.json();
            if (!raw || !raw[1]) { console.warn(`No WB data for ${countryCode}`); return forChart ? [] : {}; }
            if (forChart) return raw[1].map(d => ({ year: d.date, value: d.value })).filter(d => d.value !== null).sort((a, b) => a.year - b.year);
            const data = {};
            raw[1].forEach(d => {
                const key = d.indicator.id.replaceAll('.', '_');
                if (d.value !== null && (!data[key] || d.date > data[key].date)) {
                   data[key] = { value: d.value, date: d.date };
                }
            });
            return data;
        } catch (error) { console.error(`Fetch Error (WB):`, error); return forChart ? [] : {}; }
    }

    async function fetchImfData(countryCode, indicator, forChart = false) {
        const targetUrl = `https://www.imf.org/external/datamapper/api/v1/${indicator}/${countryCode}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
        try {
            const res = await fetch(proxyUrl);
            if (!res.ok) { console.error(`CORS Proxy Error (IMF): ${res.status}`); return forChart ? [] : {}; }
            const raw = await res.json();
            const values = raw.values?.[indicator]?.[countryCode];
            if (!values) { console.warn(`No IMF data for ${indicator}/${countryCode}`); return forChart ? [] : {}; }
            if (forChart) return Object.entries(values).map(([year, value]) => ({ year, value })).sort((a, b) => a.year - b.year);
            const latestYear = Object.keys(values).filter(y => parseInt(y) <= new Date().getFullYear()).pop();
            return { [indicator.replaceAll('.', '_')]: { value: values[latestYear], date: latestYear } };
        } catch (error) { console.error(`Fetch Error (IMF):`, error); return forChart ? [] : {}; }
    }
    
    async function fetchOecdGini(countryCode) {
        const url = `https://stats.oecd.org/SDMX-JSON/data/IDD/${countryCode}.GINI.CURRENT.LATEST/all?dimensionAtObservation=allDimensions`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        try {
            const res = await fetch(proxyUrl);
            if (!res.ok) return null;
            const raw = await res.json();
            if (!raw || !raw.dataSets || !raw.dataSets[0] || !raw.dataSets[0].series) {
                console.warn(`OECD GINI data structure not as expected for ${countryCode}.`);
                return null;
            }
            const series = raw.dataSets[0].series['0:0:0:0'];
            if (!series || !series.observations) {
                console.warn(`No OECD GINI observations found for ${countryCode}.`);
                return null;
            }
            const obsKeys = Object.keys(series.observations);
            if (obsKeys.length === 0) {
                 console.warn(`OECD GINI observation object is empty for ${countryCode}.`);
                return null;
            }
            const latestObsKey = obsKeys[obsKeys.length - 1];
            const latestObs = series.observations[latestObsKey];
            const year = raw.structure.dimensions.observation[4].values[latestObsKey].name;
            return { value: latestObs[0], date: year };
        } catch (error) { console.error(`Fetch Error (OECD):`, error); return null; }
    }

    // --- Bayesian Network Logic ---
    function discretize(value, thresholds) {
        if (value === null || value === undefined) return null;
        const [t1, t2, invert] = thresholds;
        if (invert) {
            if (value <= t2) return STATES.Strong;
            if (value <= t1) return STATES.Moderate;
            return STATES.Weak;
        } else {
            if (value >= t2) return STATES.Strong;
            if (value >= t1) return STATES.Moderate;
            return STATES.Weak;
        }
    }

    function runBayesianInference(rawData) {
        const nodeStates = {};

        // 1. Discretize leaf nodes (raw indicators)
        const ageDependency = (rawData.SP_POP_DPND_OL?.value || 0) + (rawData.SP_POP_DPND_YG?.value || 0);
        const manufValue = rawData.NV_IND_MANF_ZS?.value;
        const financeValue = rawData.NV_FSM_TOTL_ZS?.value;
        const manufVsFinance = (financeValue > 0) ? manufValue / financeValue : null;

        nodeStates.epi = discretize(rawData.EPI?.value, DISCRETIZATION_THRESHOLDS.epi);
        nodeStates.nd_gain = discretize(rawData.ND_GAIN?.value, DISCRETIZATION_THRESHOLDS.nd_gain);
        nodeStates.co2 = discretize(rawData.EN_ATM_CO2E_PC?.value, DISCRETIZATION_THRESHOLDS.co2);
        nodeStates.renewable = discretize(rawData.EG_ELC_RNWX_ZS?.value, DISCRETIZATION_THRESHOLDS.renewable);
        nodeStates.fertility = discretize(rawData.SP_DYN_TFRT_IN?.value, DISCRETIZATION_THRESHOLDS.fertility);
        nodeStates.age_dependency = discretize(ageDependency, DISCRETIZATION_THRESHOLDS.age_dependency);
        nodeStates.gdp_pc = discretize(rawData.NY_GDP_PCAP_CD?.value, DISCRETIZATION_THRESHOLDS.gdp_pc);
        nodeStates.current_account = discretize(rawData.BN_CAB_XOKA_GD_ZS?.value, DISCRETIZATION_THRESHOLDS.current_account);
        nodeStates.manuf_vs_finance = discretize(manufVsFinance, DISCRETIZATION_THRESHOLDS.manuf_vs_finance);
        nodeStates.rd_exp = discretize(rawData.GB_XPD_RSDV_GD_ZS?.value, DISCRETIZATION_THRESHOLDS.rd_exp);
        nodeStates.patents = discretize(rawData.IP_PAT_RESD?.value, DISCRETIZATION_THRESHOLDS.patents);
        nodeStates.internet_users = discretize(rawData.IT_NET_USER_ZS?.value, DISCRETIZATION_THRESHOLDS.internet_users);
        nodeStates.gini = discretize(rawData.SI_POV_GINI?.value, DISCRETIZATION_THRESHOLDS.gini);
        nodeStates.corruption_control = discretize(rawData.CC_PER_RNK?.value, DISCRETIZATION_THRESHOLDS.corruption_control);
        nodeStates.rule_of_law = discretize(rawData.RL_PER_RNK?.value, DISCRETIZATION_THRESHOLDS.rule_of_law);
        nodeStates.political_stability = discretize(rawData.PV_PER_RNK?.value, DISCRETIZATION_THRESHOLDS.political_stability);
        nodeStates.military_exp = discretize(rawData.MS_MIL_XPND_GD_ZS?.value, DISCRETIZATION_THRESHOLDS.military_exp);
        
        // 2. Infer states of composite nodes
        for (const nodeName of Object.keys(NETWORK_STRUCTURE)) {
            const parents = NETWORK_STRUCTURE[nodeName];
            const cpt = CPTs[nodeName];
            let distribution;

            if (nodeName === 'hegemonicCyclePosition') {
                const powerState = REVERSE_STATES[nodeStates.relativePowerProjection?.state];
                const resilienceState = REVERSE_STATES[nodeStates.nationalResilience?.state];
                distribution = cpt.table[powerState]?.[resilienceState] || { Rise: 0.25, Consolidation: 0.25, Decline: 0.25, Transition: 0.25 };
            } else {
                let influenceScore = 0;
                let totalWeight = 0;
                for (const parent of parents) {
                    const parentState = nodeStates[parent];
                    const weight = cpt.weights[parent];
                    influenceScore += (parentState === null ? STATES.Moderate : parentState) * weight;
                    totalWeight += weight;
                }
                const normalizedInfluence = Math.max(0, Math.min(2, Math.round((influenceScore / totalWeight))));
                distribution = cpt.table[normalizedInfluence] || { Weak: 0.34, Moderate: 0.33, Strong: 0.33 };
            }
            
            const mostLikelyState = Object.keys(distribution).reduce((a, b) => distribution[a] > distribution[b] ? a : b);
            
            nodeStates[nodeName] = {
                state: nodeName === 'hegemonicCyclePosition' ? CYCLE_STATES[mostLikelyState] : STATES[mostLikelyState],
                distribution: distribution,
                stateName: mostLikelyState
            };
        }
        return nodeStates;
    }

    async function runAnalysis() {
        if (!dashboardContentWrapper) return;
        dashboardContentWrapper.classList.add('hidden');
        loader.classList.remove('hidden');
        
        try {
            const rawData = await fetchData(currentCountryCode);
            const modelOutput = runBayesianInference(rawData);
            
            updateDashboard(modelOutput);
            
            const trendIndicator = TREND_INDICATORS[currentTrendIndicator];
            const historicalData = trendIndicator.source === 'WB' 
                ? await fetchWorldBankData(currentCountryCode, trendIndicator.code, '2000:2023', true)
                : await fetchImfData(currentCountryCode, trendIndicator.code, true);
            updateHistoricalChart(historicalData, currentTrendIndicator);
        } catch (error) {
            console.error("An error occurred during analysis:", error);
            // Optionally, display an error message to the user in the UI
        } finally {
            loader.classList.add('hidden');
            dashboardContentWrapper.classList.remove('hidden');
        }
    }

    // --- UI Update Functions ---
    function updateDashboard(output) {
        const countryName = COUNTRIES[currentCountryCode];
        updateHegemonicDisplay(output.hegemonicCyclePosition);
        updateCoreDiagnostics(output);
        updateCycleExplanation(output.hegemonicCyclePosition.stateName, countryName, output);
    }

    function createProbBar(distribution) {
        const colors = { Weak: 'bg-pink-600', Moderate: 'bg-orange-500', Strong: 'bg-blue-600', Rise: 'bg-blue-600', Consolidation: 'bg-blue-600', Decline: 'bg-pink-600', Transition: 'bg-orange-500' };
        let html = '<div class="prob-bar-container">';
        for(const state in distribution) {
            const prob = distribution[state] * 100;
            if (prob > 0) {
                html += `<div class="prob-bar ${colors[state] || 'bg-gray-500'}" style="width: ${prob}%">${prob > 10 ? state : ''}</div>`;
            }
        }
        html += '</div>';
        return html;
    }

    function updateHegemonicDisplay(hegemonNode) {
        document.getElementById('hegemonic-distribution').innerHTML = createProbBar(hegemonNode.distribution);
    }

    function updateCoreDiagnostics(output) {
        const container = document.getElementById('core-diagnostics-container');
        if (!container) return;

        const nodesToDisplay = {
            'National Resilience': output.nationalResilience,
            'Relative Power Projection': output.relativePowerProjection,
            'Economic Engine Type': output.economicEngineType,
            'Technological Capacity': output.technologicalCapacity,
            'Social Cohesion': output.socialCohesion,
        };

        let html = '';
        for (const label in nodesToDisplay) {
            const node = nodesToDisplay[label];
            html += `<div><span class="text-gray-400">${label}</span>`;
            if (node && node.stateName) {
                html += `<p class="text-xl font-bold text-white mt-1">${node.stateName}</p>`;
                html += createProbBar(node.distribution);
            } else {
                 html += `<p class="text-xl font-bold text-gray-600 mt-1">Data Missing</p>`;
            }
            html += `</div>`;
        }
        container.innerHTML = html;
    }
    
    function updateHistoricalChart(data, label) {
        const ctx = document.getElementById('historical-chart').getContext('2d');
        if (historicalChart) historicalChart.destroy();
        historicalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.year),
                datasets: [{ label: label, data: data.map(d => d.value), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 }]
            },
            options: chartOptions(true)
        });
    }

    function updateCycleExplanation(position, countryName, modelOutput) {
        const container = document.getElementById('cycle-explanation-scenarios');
        const explanations = {
            'Rise': 'A rising power is characterized by strong economic growth, high social cohesion, and rapid technological advancement, allowing it to expand its influence.',
            'Consolidation': 'A consolidated hegemon is at the peak of its power, providing global public goods and underwriting the international system with its dominant economy and military.',
            'Decline': 'A declining power faces internal fragmentation, imperial overstretch, and rising challengers. It often shifts from providing stability to extracting value from the system.',
            'Transition': 'A period of transition is marked by high instability and geopolitical chaos as the old order breaks down and new powers compete to shape the next one.'
        };
        
        // --- DYNAMIC SCENARIOS ---
        const drivers = {
            strength: modelOutput.technologicalCapacity.stateName === 'Strong' ? 'its strong Technological Capacity' : 'a robust Economic Engine',
            weakness: modelOutput.socialCohesion.stateName === 'Weak' ? 'significant social fragmentation' : 'a financialized economy prone to overstretch',
        };

        const scenarios = {
            'Rise': `<h5 class="font-bold text-white mt-4">Investor Scenarios for ${countryName}:</h5><ul class="list-disc list-inside space-y-1"><li><b>Bull Case:</b> Long-term investment in domestic infrastructure and technology sectors to capture the growth driven by ${drivers.strength}.</li><li><b>Base Case:</b> Expect volatility as ${countryName} challenges the existing order. Focus on sectors aligned with its state-led industrial policy.</li><li><b>Bear Case:</b> Risk of premature over-expansion or a harsh counter-reaction from incumbent powers, leading to trade wars and instability.</li></ul>`,
            'Consolidation': `<h5 class="font-bold text-white mt-4">Investor Scenarios for ${countryName}:</h5><ul class="list-disc list-inside space-y-1"><li><b>Bull Case:</b> Stable returns from mature, globally integrated markets and ${countryName}'s currency, underpinned by ${drivers.strength}.</li><li><b>Base Case:</b> Focus on blue-chip equities and sovereign bonds, but watch for signs of complacency and the beginnings of ${drivers.weakness}.</li><li><b>Bear Case:</b> The start of "imperial overstretch"; military commitments may grow faster than the economic base, planting the seeds of future decline.</li></ul>`,
            'Decline': `<h5 class="font-bold text-white mt-4">Investor Scenarios for ${countryName}:</h5><ul class="list-disc list-inside space-y-1"><li><b>Bull Case:</b> Despite the overall decline, ${drivers.strength} may offer short-term opportunities in specialized, high-margin sectors.</li><li><b>Base Case:</b> Increased market volatility and political risk driven by ${drivers.weakness}. Diversify away from ${countryName}'s currency and debt. Hedge against inflation.</li><li><b>Bear Case:</b> A rapid, disorderly collapse of financial and political systems, triggering a global crisis. Capital flight to rising powers.</li></ul>`,
            'Transition': `<h5 class="font-bold text-white mt-4">Investor Scenarios for ${countryName}:</h5><ul class="list-disc list-inside space-y-1"><li><b>Bull Case:</b> High-risk, high-reward opportunities in the technologies and regions that will define the next cycle, leveraging ${countryName}'s residual ${drivers.strength}.</li><li><b>Base Case:</b> A chaotic, multipolar world. Focus on resilient, localized supply chains and assets that hold value in times of uncertainty (e.g., commodities).</li><li><b>Bear Case:</b> Systemic fragmentation and major power conflict, exacerbated by ${drivers.weakness}, leading to a prolonged period of deglobalization.</li></ul>`
        };
        container.innerHTML = `<p>${explanations[position] || 'Analysis complete.'}</p>${scenarios[position] || ''}`;
    }

    function chartOptions(isTimeSeries = false) {
        const options = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#d1d5db', font: { family: "'Playfair Display', serif" } } } },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#d1d5db', font: { family: "'Playfair Display', serif" } } },
                x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#d1d5db', font: { family: "'Playfair Display', serif" } } }
            }
        };
        if (isTimeSeries) { options.scales.x.type = 'time'; options.scales.x.time = { unit: 'year' }; }
        return options;
    }
    
    function buildModelExplorer() {
        const container = document.getElementById('model-cpt-content');
        container.innerHTML = '';
        const friendlyNames = { ...LEAF_NODES, socialCohesion: 'Social Cohesion', demographicDynamism: 'Demographic Dynamism', biosphereIntegrity: 'Biosphere Integrity', economicEngineType: 'Economic Engine Type', technologicalCapacity: 'Technological Capacity', relativePowerProjection: 'Relative Power Projection', nationalResilience: 'National Resilience' };

        for (const nodeName in CPTs) {
            const cpt = CPTs[nodeName];
            const componentName = nodeName.replace(/([A-Z])/g, ' $1').trim();
            let html = `<div class="p-4 border border-gray-800 rounded-lg bg-gray-900/50">
                            <h4 class="text-lg font-semibold text-blue-400 mb-3">${componentName}</h4>`;

            if (nodeName === 'hegemonicCyclePosition') {
                html += `<p class="text-sm text-gray-400 mb-4">Determined by the states of Relative Power Projection and National Resilience.</p>
                         <table class="cpt-table">
                            <thead><tr><th>P(Hegemon | Power, Resilience)</th>${REVERSE_CYCLE_STATES.map(s => `<th>${s}</th>`).join('')}</tr></thead>
                            <tbody>`;
                for (const powerState of REVERSE_STATES) {
                    for (const resilienceState of REVERSE_STATES) {
                         const rowId = `${powerState}-${resilienceState}`;
                         html += `<tr><td>If Power is <b>${powerState}</b> and Resilience is <b>${resilienceState}</b></td>`;
                         const dist = cpt.table[powerState][resilienceState];
                         for(const cycleState of REVERSE_CYCLE_STATES) {
                            html += `<td><input type="number" class="cpt-input" value="${(dist[cycleState]*100).toFixed(0)}" data-node="${nodeName}" data-row-id="${rowId}" data-state="${cycleState}"> %</td>`;
                         }
                         html += `</tr>`;
                    }
                }
                html += `</tbody></table>`;
            } else {
                const parents = NETWORK_STRUCTURE[nodeName];
                html += `<p class="text-sm text-gray-400 mb-2">Parents: ${parents.map(p => friendlyNames[p] || p).join(', ')}</p>
                         <table class="cpt-table">
                            <thead><tr><th>If Avg. Parent State is...</th><th>P(Weak)</th><th>P(Moderate)</th><th>P(Strong)</th></tr></thead>
                            <tbody>`;
                cpt.table.forEach((dist, i) => {
                    html += `<tr><td><b>${REVERSE_STATES[i]}</b></td>`;
                    for(const state of REVERSE_STATES) {
                         html += `<td><input type="number" class="cpt-input" value="${(dist[state]*100).toFixed(0)}" data-node="${nodeName}" data-row-index="${i}" data-state="${state}"> %</td>`;
                    }
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
            }
            html += `</div>`;
            container.innerHTML += html;
        }
        
        // Add event listeners for editable CPTs
        document.querySelectorAll('.cpt-input').forEach(input => {
            input.addEventListener('change', handleCptInputChange);
        });

        buildModelGraph();
    }

    function handleCptInputChange(e) {
        const input = e.target;
        const nodeName = input.dataset.node;
        const state = input.dataset.state;
        let newValue = parseFloat(input.value);

        if (isNaN(newValue)) {
            // Reset if invalid input
            input.value = parseFloat(input.defaultValue);
            return;
        }
        newValue = Math.max(0, Math.min(100, newValue)); // Clamp between 0 and 100

        let distribution, allStates;

        if (nodeName === 'hegemonicCyclePosition') {
            const [powerState, resilienceState] = input.dataset.rowId.split('-');
            distribution = CPTs[nodeName].table[powerState][resilienceState];
            allStates = REVERSE_CYCLE_STATES;
        } else {
            const rowIndex = parseInt(input.dataset.rowIndex);
            distribution = CPTs[nodeName].table[rowIndex];
            allStates = REVERSE_STATES;
        }
        
        const oldValue = distribution[state] * 100;
        const delta = newValue - oldValue;
        
        // Normalize other values
        const otherStates = allStates.filter(s => s !== state);
        const otherStatesTotal = otherStates.reduce((sum, s) => sum + distribution[s] * 100, 0);

        if (otherStatesTotal > 0) {
            otherStates.forEach(s => {
                const share = (distribution[s] * 100) / otherStatesTotal;
                distribution[s] -= (delta * share) / 100;
                distribution[s] = Math.max(0, distribution[s]); // Ensure no negative probability
            });
        }
        
        distribution[state] = newValue / 100;

        // Final normalization pass to correct floating point errors and ensure sum is 1
        const currentSum = allStates.reduce((sum, s) => sum + distribution[s], 0);
        allStates.forEach(s => distribution[s] /= currentSum);

        // Update UI and re-run analysis
        buildModelExplorer(); // Re-renders the tables with new values and re-attaches listeners
        runAnalysis();
    }

    function buildDataSourcesManager() {
        const container = document.getElementById('data-sources-content');
        container.innerHTML = '';
        for (const key in dataSources) {
            const source = dataSources[key];
            container.innerHTML += `
                <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-800 flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-white">${source.name} <span class="text-xs uppercase font-bold ${source.type === 'public' || source.type === 'static' ? 'text-green-400' : 'text-yellow-400'}">${source.type}</span></h4>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm mr-2 ${source.enabled ? 'text-gray-300' : 'text-gray-500'}">${source.enabled ? 'Enabled' : 'Disabled'}</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" ${source.enabled ? 'checked' : ''} data-sourcekey="${key}">
                            <div class="relative w-11 h-6 bg-gray-700 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            `;
        }

        document.querySelectorAll('#data-sources-content input[type="checkbox"]').forEach(toggle => {
            toggle.addEventListener('change', (e) => {
                const { sourcekey } = e.target.dataset;
                dataSources[sourcekey].enabled = e.target.checked;
                document.getElementById('data-sources-active').textContent = Object.values(dataSources).filter(s => s.enabled).length;
                runAnalysis();
            });
        });
        document.getElementById('data-sources-active').textContent = Object.values(dataSources).filter(s => s.enabled).length;
    }

    function buildModelGraph() {
        const container = document.getElementById('model-graph-container');
        
        const nodePositions = {};
        const columnX = [50, 350, 650, 950];

        let html = `<svg width="1100" height="900">
            <defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280" /></marker></defs>
            <style>
                .node-text { font-family: 'Playfair Display', serif; font-size: 16px; }
                .l0 { fill: #9ca3af; } /* Leaf */
                .l1 { fill: #60a5fa; font-weight: bold; } /* Level 1 Composite */
                .l2 { fill: #f97316; font-weight: bold; } /* Level 2 Composite */
                .l3 { fill: #ec4899; font-weight: bold; } /* Final */
                .edge { stroke: #6b7280; stroke-width: 1.5; marker-end: url(#arrow); fill: none; }
            </style>`;

        // Position nodes
        const orderedLeafNodes = [
            'epi', 'nd_gain', 'co2', 'renewable', 
            'fertility', 'age_dependency',
            'gdp_pc', 'current_account', 'manuf_vs_finance',
            'rd_exp', 'patents', 'internet_users',
            'military_exp',
            'gini', 'corruption_control', 'rule_of_law', 'political_stability', 
        ];
        const l1Nodes = ['biosphereIntegrity', 'demographicDynamism', 'economicEngineType', 'technologicalCapacity', 'socialCohesion'];
        const l2Nodes = ['nationalResilience', 'relativePowerProjection'];
        const l3Nodes = ['hegemonicCyclePosition'];

        [orderedLeafNodes, l1Nodes, l2Nodes, l3Nodes].forEach((nodes, colIdx) => {
            const yStep = 900 / (nodes.length + 1);
            nodes.forEach((nodeName, rowIdx) => {
                nodePositions[nodeName] = { x: columnX[colIdx] + 75, y: (rowIdx + 1) * yStep };
            });
        });
        
        // Draw edges
        for (const nodeName in NETWORK_STRUCTURE) {
            const parents = NETWORK_STRUCTURE[nodeName];
            parents.forEach(parentName => {
                const p1 = nodePositions[parentName];
                const p2 = nodePositions[nodeName];
                if (p1 && p2) {
                    html += `<path d="M ${p1.x + 70} ${p1.y} C ${p1.x + 170} ${p1.y}, ${p2.x - 170} ${p2.y}, ${p2.x - 70} ${p2.y}" class="edge" />`;
                }
            });
        }

        // Draw nodes
        for (const nodeName in nodePositions) {
            const pos = nodePositions[nodeName];
            let levelClass = 'l0';
            if (l1Nodes.includes(nodeName)) levelClass = 'l1';
            if (l2Nodes.includes(nodeName)) levelClass = 'l2';
            if (l3Nodes.includes(nodeName)) levelClass = 'l3';
            
            const displayName = LEAF_NODES[nodeName] || nodeName.replace(/([A-Z])/g, ' $1').trim();
            html += `<text x="${pos.x}" y="${pos.y}" class="node-text ${levelClass}" text-anchor="middle">${displayName}</text>`;
        }

        html += `</svg>`;
        container.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
